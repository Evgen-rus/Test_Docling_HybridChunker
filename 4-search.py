import lancedb
from lancedb.embeddings import get_registry

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
print("üîç –ü–æ–¥–∫–ª—é—á–∞—é—Å—å –∫ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑–µ LanceDB...")
db = lancedb.connect("data/lancedb")
table = db.open_table("docling")

print(f"üìä –í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö: {table.count_rows()} –∑–∞–ø–∏—Å–µ–π")

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–∏—Å–∫–∞
func = get_registry().get("openai").create(name="text-embedding-3-small")

# –¢–µ—Å—Ç–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø–æ –≤–∞—à–µ–º—É –¥–æ–∫—É–º–µ–Ω—Ç—É –æ –ª–æ–≥–∏–∫–µ –ø—Ä–æ–¥–∞–∂
test_queries = [
    "–ö–∞–∫ –ø—Ä–æ–≤–æ–¥–∏—Ç—å –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—é –∫–ª–∏–µ–Ω—Ç–æ–≤?",
    "–ß—Ç–æ —Ç–∞–∫–æ–µ —Ç–µ—Å—Ç–æ–≤—ã–π –ø–µ—Ä–∏–æ–¥?",
    "–ö–∞–∫ –æ—Ü–µ–Ω–∏–≤–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –ª–∏–¥–æ–≤?",
    "–≠—Ç–∞–ø—ã –ø—Ä–æ–¥–∞–∂–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞",
    "–ú–∏–∫—Ä–æ–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç—É",
    "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ç–µ—Ä–º–∏–Ω–æ–≤ —Å –∫–ª–∏–µ–Ω—Ç–æ–º"
]

print("\n" + "="*60)
print("–¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ü–û–ò–°–ö–ê –ü–û –î–û–ö–£–ú–ï–ù–¢–£ –û –õ–û–ì–ò–ö–ï –ü–†–û–î–ê–ñ:")
print("="*60)

for query in test_queries:
    print(f"\nüîç –ó–∞–ø—Ä–æ—Å: '{query}'")
    results = table.search(query).limit(2).to_pandas()
    
    if len(results) > 0:
        for i, row in results.iterrows():
            print(f"  üìÑ –†–µ–∑—É–ª—å—Ç–∞—Ç {i+1}:")
            print(f"     –†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: {row['_distance']:.4f}")
            print(f"     –§–∞–π–ª: {row['metadata']['filename']}")
            print(f"     –ó–∞–≥–æ–ª–æ–≤–æ–∫: {row['metadata']['title']}")
            print(f"     –¢–µ–∫—Å—Ç: {row['text'][:150]}...")
            print()
    else:
        print("  ‚ùå –†–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")

print("\n" + "="*60)
print("–°–¢–ê–¢–ò–°–¢–ò–ö–ê –ë–ê–ó–´ –ó–ù–ê–ù–ò–ô:")
print("="*60)
print(f"üìà –í—Å–µ–≥–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ –≤ –±–∞–∑–µ: {table.count_rows()}")

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
sample_data = table.to_pandas()
unique_titles = sample_data['metadata'].apply(lambda x: x['title']).unique()
print(f"üìã –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤: {len(unique_titles)}")
print("üè∑Ô∏è –ü—Ä–∏–º–µ—Ä—ã –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤:")
for title in unique_titles[:5]:
    print(f"   ‚Ä¢ {title}")

print(f"\n‚úÖ –ü–æ–∏—Å–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç! –ë–∞–∑–∞ –≥–æ—Ç–æ–≤–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —á–∞—Ç–µ.")
