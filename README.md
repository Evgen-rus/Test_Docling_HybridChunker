# Создание пайплайна извлечения знаний с помощью Docling

[Docling] https://github.com/docling-project/docling
 — это мощная, гибкая библиотека с открытым исходным кодом для обработки документов, которая преобразует различные форматы документов в единый формат. Она обладает продвинутыми возможностями понимания документов, основанными на современных AI-моделях для анализа макета и распознавания структуры таблиц.

Вся система работает локально на стандартных компьютерах и спроектирована как расширяемая — разработчики могут добавлять новые модели или модифицировать пайплайн под конкретные нужды. Она особенно полезна для задач корпоративного поиска по документам, извлечения отрывков и извлечения знаний. Благодаря продвинутым возможностям разбиения на части и обработки, это идеальный инструмент для обеспечения GenAI-приложений знаниями через RAG (Retrieval Augmented Generation) пайплайны.

## Ключевые особенности

- **Универсальная поддержка форматов**: Обработка PDF, DOCX, XLSX, PPTX, Markdown, HTML, изображений и многого другого
- **Продвинутое понимание**: AI-анализ макета и распознавание структуры таблиц
- **Гибкий вывод**: Экспорт в HTML, Markdown, JSON или обычный текст
- **Высокая производительность**: Эффективная обработка на локальном оборудовании

## Над чем они работают

- Извлечение метаданных, включая заголовок, авторов, ссылки и язык
- Включение Visual Language Models (SmolDocling)
- Понимание диаграмм (гистограммы, круговые диаграммы, линейные графики и т.д.)
- Понимание сложной химии (молекулярные структуры)

## Начало работы с примером

### Предварительные требования

1. Установите необходимые пакеты:

```bash
pip install -r requirements.txt
```

2. Настройте переменные окружения, создав файл `.env`:

```bash
OPENAI_API_KEY=your_api_key_here
```

### Запуск примера

Выполните файлы по порядку для создания и запроса базы данных документов:

1. Извлечение содержимого документа: `python 1-extraction.py`
2. Создание фрагментов документа: `python 2-chunking.py`
3. Создание эмбеддингов и сохранение в LanceDB: `python 3-embedding.py`
4. Тестирование базовой функциональности поиска: `python 4-search.py`
5. Запуск интерфейса чата Streamlit: `streamlit run 5-chat.py`

Затем откройте браузер и перейдите по адресу `http://localhost:8501` для взаимодействия с интерфейсом вопросов и ответов по документам.

## Обработка документов

### Поддерживаемые входные форматы

| Формат | Описание |
|--------|----------|
| PDF | Нативные PDF-документы с сохранением макета |
| DOCX, XLSX, PPTX | Форматы Microsoft Office (2007+) |
| Markdown | Обычный текст с разметкой |
| HTML/XHTML | Веб-документы |
| Изображения | PNG, JPEG, TIFF, BMP |
| USPTO XML | Патентные документы |
| PMC XML | Статьи PubMed Central |


### Поддерживаемые выходные форматы

Format	Description
HTML	Both image embedding and referencing are supported
Markdown	
JSON	Lossless serialization of Docling Document
Text	Plain text, i.e. without Markdown markers
Doctags	

Ознакомьтесь с этой [страницей](https://docling-project.github.io/docling/usage/supported_formats/) для получения актуального списка.

### Пайплайн обработки

Стандартный пайплайн включает:

1. Парсинг документа с бэкендом для конкретного формата
2. Анализ макета с использованием AI-моделей
3. Распознавание структуры таблиц
4. Извлечение метаданных
5. Организация и структурирование контента
6. Форматирование экспорта

## Модели

Docling использует две основные специализированные AI-модели для понимания документов. В основе лежит модель анализа макета, построенная на архитектуре `RT-DETR (Real-Time Detection Transformer)`, которая превосходно обнаруживает и классифицирует элементы страницы. Эта модель обрабатывает страницы с разрешением 72 dpi и может анализировать одну страницу менее чем за секунду на стандартном CPU, будучи обученной на комплексном датасете `DocLayNet`.

Вторая ключевая модель — `TableFormer`, система распознавания структуры таблиц, которая может обрабатывать сложные макеты таблиц, включая частичные границы, пустые ячейки, объединенные ячейки и иерархические заголовки. TableFormer обычно обрабатывает таблицы за 2-6 секунд на CPU, что делает его эффективным для практического использования.

Для документов, требующих извлечения текста из изображений, Docling интегрирует `EasyOCR` как опциональный компонент, который работает с разрешением 216 dpi для оптимального качества, но требует около 30 секунд на страницу. Обе модели — анализа макета и TableFormer — были разработаны IBM Research и доступны публично как предобученные веса на Hugging Face под "ds4sd/docling-models".

Для более подробной информации об этих моделях и их реализации вы можете обратиться к [технической документации](https://arxiv.org/pdf/2408.09869).

## Разбиение на фрагменты (Chunking)

Когда вы создаете RAG (Retrieval Augmented Generation) приложение, вам нужно разбить документы на более мелкие, осмысленные части, которые можно легко искать и извлекать. Но это не так просто, как просто разделить текст каждые X слов или символов.

Что делает [разбиение Docling](https://ds4sd.github.io/docling/concepts/chunking/) уникальным, так это то, что оно понимает фактическую структуру вашего документа. У него есть два основных подхода:

1. [Hybrid Chunker](https://docling-project.github.io/docling/concepts/chunking/#hybrid-chunker) идет еще дальше. Он начинает с иерархических фрагментов, но затем:
   - Может разделить фрагменты, которые слишком велики для вашей модели эмбеддингов
   - Может сшить вместе фрагменты, которые слишком малы
   - Работает с вашим конкретным токенизатором, поэтому фрагменты идеально подойдут к выбранной языковой модели

### Почему это отлично для RAG-приложений?

Представьте, что вы создаете систему для ответов на вопросы по техническим документам. С базовым разбиением (например, разделение каждые 500 слов) вы можете разрезать прямо посередине таблицы или отделить заголовок от его содержимого. Но умное разбиение Docling:

- Держит связанную информацию вместе
- Сохраняет структуру документа
- Поддерживает контекст (например, заголовки и подписи)
- Создает фрагменты, оптимизированные для вашей конкретной модели эмбеддингов
- Обеспечивает осмысленность и самодостаточность каждого фрагмента

Это означает, что когда ваша RAG-система извлекает фрагменты, они будут иметь правильный контекст и структуру, что приведет к более точным и связным ответам от вашей языковой модели.


## Чтобы преобразовать отдельные документы с помощью Python, используйте convert(), например:

from docling.document_converter import DocumentConverter

source = "https://arxiv.org/pdf/2408.09869"  # document per local path or URL
converter = DocumentConverter()
result = converter.convert(source)
print(result.document.export_to_markdown())  # output: "## Docling Technical Report[...]"

Более расширенные варианты использования доступны в документации.
https://docling-project.github.io/docling/usage/


## Документация

Подробную информацию об установке, использовании, концепциях, рецептах, расширениях и многом другом можно найти в документации
https://docling-project.github.io/docling/